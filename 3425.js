"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3425],{23425:(q,P,s)=>{s.d(P,{_:()=>K});var b=s(15861),m=s(15439),f=s(42654),h=s(2994),v=s(72986),_=s(87545),S=s(27221),k=s(71243),y=s(75359),O=s(82064),t=s(94650),A=s(31443),d=s(18779),x=s(10640),I=s(62188),T=s(36467),B=s(40486),M=s(38629),D=s(51982),g=s(36895),C=s(99274),w=s(78535);const E=["radioGroup"];function F(a,p){if(1&a&&(t.\u0275\u0275elementStart(0,"ion-label",11),t.\u0275\u0275text(1),t.\u0275\u0275pipe(2,"translate"),t.\u0275\u0275elementEnd()),2&a){const e=t.\u0275\u0275nextContext().$implicit;t.\u0275\u0275nextContext();const n=t.\u0275\u0275reference(2);t.\u0275\u0275classProp("selected",n.value==e.count),t.\u0275\u0275advance(1),t.\u0275\u0275textInterpolate2(" ",e.count," ",t.\u0275\u0275pipeBind1(2,4,"one_attender")," ")}}function U(a,p){if(1&a&&(t.\u0275\u0275elementStart(0,"ion-label",11),t.\u0275\u0275text(1),t.\u0275\u0275pipe(2,"translate"),t.\u0275\u0275elementEnd()),2&a){const e=t.\u0275\u0275nextContext().$implicit;t.\u0275\u0275nextContext();const n=t.\u0275\u0275reference(2);t.\u0275\u0275classProp("selected",n.value==e.count),t.\u0275\u0275advance(1),t.\u0275\u0275textInterpolate2(" ",e.count," ",t.\u0275\u0275pipeBind1(2,4,"attenders")," ")}}function V(a,p){if(1&a){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementStart(0,"div",6),t.\u0275\u0275listener("click",function(){const i=t.\u0275\u0275restoreView(e).$implicit,l=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(l.onChange(i.count))}),t.\u0275\u0275elementStart(1,"div",7),t.\u0275\u0275element(2,"ion-radio",8),t.\u0275\u0275template(3,F,3,6,"ion-label",9),t.\u0275\u0275template(4,U,3,6,"ion-label",9),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(5,"ion-text",10),t.\u0275\u0275text(6),t.\u0275\u0275pipe(7,"price_format"),t.\u0275\u0275elementEnd()()}if(2&a){const e=p.$implicit,n=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(2),t.\u0275\u0275propertyInterpolate("value",e.count),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",1===e.count),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",e.count>1),t.\u0275\u0275advance(2),t.\u0275\u0275textInterpolate(t.\u0275\u0275pipeBind2(7,4,e.price*e.count,n.currency))}}function L(a,p){if(1&a&&(t.\u0275\u0275elementStart(0,"div",2)(1,"ion-radio-group",3,4),t.\u0275\u0275template(3,V,8,7,"div",5),t.\u0275\u0275elementEnd()()),2&a){const e=t.\u0275\u0275nextContext();t.\u0275\u0275advance(1),t.\u0275\u0275propertyInterpolate("value",e.proposals[0].count),t.\u0275\u0275advance(2),t.\u0275\u0275property("ngForOf",e.proposals)}}function z(a,p){1&a&&t.\u0275\u0275element(0,"ion-skeleton-text",12)}let j=(()=>{class a{constructor(){this.countChanged=new t.EventEmitter}ngOnChanges(){this.proposals.sort((e,n)=>e.count-n.count)}onChange(e){this.radioGroup.value=e.toString(),this.countChanged.emit(e)}}return a.\u0275fac=function(e){return new(e||a)},a.\u0275cmp=t.\u0275\u0275defineComponent({type:a,selectors:[["app-select-count-player"]],viewQuery:function(e,n){if(1&e&&t.\u0275\u0275viewQuery(E,5),2&e){let o;t.\u0275\u0275queryRefresh(o=t.\u0275\u0275loadQuery())&&(n.radioGroup=o.first)}},inputs:{proposals:"proposals",selected:"selected",price:"price",currency:"currency"},outputs:{countChanged:"countChanged"},features:[t.\u0275\u0275NgOnChangesFeature],decls:2,vars:2,consts:[["class","choices shadow-bottom-ligth",4,"ngIf"],["class","proposal-skeleton ","animated","",4,"ngIf"],[1,"choices","shadow-bottom-ligth"],[3,"value"],["radioGroup",""],["class","attendee",3,"click",4,"ngFor","ngForOf"],[1,"attendee",3,"click"],[1,"radio"],["slot","start","mode","md",3,"value"],["style","text-transform: lowercase;",3,"selected",4,"ngIf"],[1,"price"],[2,"text-transform","lowercase"],["animated","",1,"proposal-skeleton"]],template:function(e,n){1&e&&(t.\u0275\u0275template(0,L,4,2,"div",0),t.\u0275\u0275template(1,z,1,0,"ion-skeleton-text",1)),2&e&&(t.\u0275\u0275property("ngIf",n.proposals&&n.proposals[0]),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",!(n.proposals&&n.proposals[0])))},dependencies:[g.NgForOf,g.NgIf,d.IonLabel,d.IonRadio,d.IonRadioGroup,d.IonSkeletonText,d.IonText,d.RadioValueAccessor,d.SelectValueAccessor,C.X$,w.E],styles:[".choices[_ngcontent-%COMP%]{padding:0 1.5rem;background:white}.choices[_ngcontent-%COMP%]   .attendee[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:space-between;padding:1.5rem 0}.choices[_ngcontent-%COMP%]   .radio[_ngcontent-%COMP%]{display:flex;align-items:center;-ms-flex-align:start}.choices[_ngcontent-%COMP%]   .radio[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{margin-left:1rem;font-size:var(--app-font-size)}.choices[_ngcontent-%COMP%]   .radio[_ngcontent-%COMP%]   .selected[_ngcontent-%COMP%]{font-weight:700}.choices[_ngcontent-%COMP%]   .price[_ngcontent-%COMP%]{-ms-flex-align:end;color:var(--ion-color-primary);font-size:var(--app-font-size)}.proposal-skeleton[_ngcontent-%COMP%]{width:100%;height:104px}"]}),a})();var $=s(31734),Y=s(42025),N=s(26649),G=s(76970);function Q(a,p){1&a&&(t.\u0275\u0275elementStart(0,"div",2),t.\u0275\u0275text(1,"Options"),t.\u0275\u0275elementEnd())}function R(a,p){if(1&a){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementStart(0,"app-select-playground-options",11),t.\u0275\u0275listener("optionChanged",function(o){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(i.optionChanged(o))})("countOptionChanged",function(o){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(i.countOptionChanged(o))}),t.\u0275\u0275elementEnd()}if(2&a){const e=t.\u0275\u0275nextContext();t.\u0275\u0275property("options",e.options)("currency",e.club.currency)}}function H(a,p){1&a&&(t.\u0275\u0275elementStart(0,"div",12),t.\u0275\u0275text(1),t.\u0275\u0275pipe(2,"translate"),t.\u0275\u0275elementEnd()),2&a&&(t.\u0275\u0275advance(1),t.\u0275\u0275textInterpolate(t.\u0275\u0275pipeBind1(2,1,"booking_attenders_subtitle")))}function W(a,p){1&a&&(t.\u0275\u0275elementStart(0,"div",12),t.\u0275\u0275element(1,"br"),t.\u0275\u0275elementEnd())}function X(a,p){if(1&a){const e=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementStart(0,"app-booking-add-user-choice-modal",13),t.\u0275\u0275listener("closeModal",function(){t.\u0275\u0275restoreView(e);const o=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(o.closeModalAddFriendOrUser())})("addParticipant",function(o){t.\u0275\u0275restoreView(e);const i=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(i.addParticipant(o))}),t.\u0275\u0275elementEnd()}}let K=(()=>{class a{constructor(e,n,o,i,l,r,c,u,Z,J){this.toastService=e,this.ctrl=n,this.userService=o,this.priceCalculatorService=i,this.accountService=l,this.playgroundService=r,this.cd=c,this.environmentService=u,this.clubStore=Z,this.clubIdStorageService=J,this.attenders=[],this.countPlayer=null,this.choicesCountPlayerWithPrice=[],this.priceUsed=null,this.allSubscriptions$=new f.w,this.currentClubSub=new f.w,this.allDataLoaded=!1,this.playgroundOptions=[],this.showOptions=!1,this.boolAddPart=!1,this.typeOfUserToAdd="",this.showModalAddFriendOrUser=!1,this.priceVariationsList=[],this.countPlayer=null,this.choicesCountPlayer=[],this.attenders=[]}ngOnInit(){this.allDataLoaded=!1,this.initializeBooking(),this.countPlayer=this.getDefaultCountPlayer(),this.currentClubSub=this.clubStore.pipe((0,y.Ys)(O.oX),(0,h.b)(o=>this.club=o)).subscribe();const n=`/clubs/playgrounds/timetables/blocks/prices/${this.getDefaultPrice(this.slotData.prices).id}/options.json?itemsPerPage=500`;this.optionsSub=this.playgroundService.getOptions(n).pipe((0,h.b)(o=>{this.options=o,this.options.map(i=>{i.option=`/clubs/playgrounds/options/${i.id}`}),this.showOptions=0!==o.length,this.cd.markForCheck()})).subscribe(),this.userSub=this.userService.get().pipe((0,v.q)(1),(0,h.b)(o=>{o&&(this.user=o,this.name=o.lastName+" "+o.firstName);const i=[],l=[];this.slotData.prices.map(c=>{c.bookable&&c.duration===this.duration&&(l[c.participantCount]={blockPrice:c.id,activity:this.activity.id},i.includes(c.participantCount)||(i.push(c.participantCount),this.choicesCountPlayer.unshift(c.participantCount),this.choicesCountPlayerWithPrice.unshift({count:c.participantCount,price:this.getPriceByCountPlayer(c.participantCount)})),this.pricesVariationsListSub=this.priceCalculatorService.getPriceVariations(c.id).subscribe(u=>{this.priceVariationsList=this.priceVariationsList.concat(u)},u=>{console.log(u)}))});const r=this.getDefaultPrice(this.slotData.prices);this.priceUsed=r,this.countPlayer=r.participantCount,this.defaultPrice=r.pricePerParticipant,this.timeTableBlockPricesId=r.id,this.activityIri=this.activity.id,null===this.countPlayer&&this.choicesCountPlayer.length>0&&(this.countPlayer=this.choicesCountPlayer[0])}),(0,_.w)(o=>this.accountService.getClientClub(o.id,this.club.id)),(0,h.b)(o=>{let i=null;o["hydra:member"].length>0&&(i=o["hydra:member"][0],this.wallet=i.wallet,this.client=i),this.startAt=this.slotData.selectTime.clone(),this.startAt.tz(this.club.timezone,!0),this.startAt.hour(this.slotData.startAt.split(":")[0]).minute(this.slotData.startAt.split(":")[1]),this.startAt.second(0);const l=this.priceCalculatorService.getClientPrice(this.priceUsed,this.priceVariationsList,this.client,this.club,this.startAt);this.attenders.push({restToPay:l.price,subscriptionCard:this.getSubscriptionCard(i,l),user:this.user}),this.allDataLoaded=!0,this.cd.markForCheck()}),(0,S.K)(o=>{throw this.allDataLoaded=!1,o})).subscribe()}getDefaultCountPlayer(){const n=[];this.slotData.prices.forEach(i=>{i.duration===this.duration&&n.push(i)});const o=n.reduce((i,l)=>l.participantCount<i.participantCount?l:i,n[0]);return o?o.participantCount:null}getSubscriptionCard(e,n){const o=this.slotData.selectTime.clone();return o.tz(this.club.timezone,!0),o.hour(this.slotData.startAt.split(":")[0]).minute(this.slotData.startAt.split(":")[1]),o.second(0),e&&e.subscriptionCardsAvailable?e.subscriptionCardsAvailable.find(i=>n&&n.subscriptionCard===i["@id"]&&m.utc(i.endDate).unix()>o.unix()&&m.utc(i.startDate).unix()<o.unix()):void 0}initializeBooking(){this.booking={timetableBlockPrice:null,activity:null,canceled:null,club:null,comments:null,startAt:null,payments:null,endAt:null,name:null,playgroundOptions:[],playgrounds:null,maxParticipantsCountLimit:null,userClient:null,participants:[],pricePerParticipant:null,paymentMethod:null,creationOrigin:this.environmentService.getEnvFile().bookingOrigin,confirmed:!1}}changeAttenders(e){this.allDataLoaded=!1,e.map(n=>{let o=null;return n.user.id!==this.user.id?(o=this.priceCalculatorService.getClientPrice(this.priceUsed,this.priceVariationsList,n.user,this.club,this.startAt),n.restToPay=o.price,n.subscriptionCard=this.getSubscriptionCard(n.user,o),n):(o=this.priceCalculatorService.getClientPrice(this.priceUsed,this.priceVariationsList,this.client,this.club,this.startAt),n.restToPay=o.price,n.subscriptionCard=this.getSubscriptionCard(n.user,o),n)}),this.attenders=e,this.allDataLoaded=!0}goToConfirmBooking(){var e=this;return(0,b.Z)(function*(){const n=e.slotData.selectTime.clone();n.tz(e.club.timezone,!0),n.hour(e.slotData.startAt.split(":")[0]).minute(e.slotData.startAt.split(":")[1]);const o=n.clone();n.second(0),o.second(0),o.add(e.duration,"seconds"),o.tz(e.club.timezone,!0);const i=[];if(e.name="",e.attenders.forEach(r=>{e.name=e.attenders.map(c=>c.user.lastName).join(" / "),"UserClient"===r.user["@type"]?i.push({user:r.user["@id"],subscriptionCard:r.subscriptionCard,restToPay:r.restToPay}):"ClubClient"===r.user["@type"]&&i.push({client:r.user["@id"],subscriptionCard:r.subscriptionCard,restToPay:r.restToPay})}),i.length<e.countPlayer&&e.environmentService.isLockedFullParticipant())return void e.toastService.presentError("error_count_participant_booking","top");const l=yield e.clubIdStorageService.getClubId().then(r=>r);e.booking={timetableBlockPrice:"/clubs/playgrounds/timetables/blocks/prices/"+e.timeTableBlockPricesId,activity:"/activities/"+e.activityIri,canceled:!1,club:"/clubs/"+l,comments:void 0,startAt:n.utc().format("YYYY-MM-DD HH:mm:ss"),payments:[],endAt:o.utc().format("YYYY-MM-DD HH:mm:ss"),name:e.name,playgroundOptions:e.playgroundOptions,playgrounds:[e.playground],maxParticipantsCountLimit:e.countPlayer,userClient:e.user["@id"],participants:i,pricePerParticipant:e.defaultPrice,paymentMethod:"",creationOrigin:e.environmentService.getEnvFile().bookingOrigin},e.ctrl.create({component:k.C,cssClass:"sport-confirm-class",componentProps:{booking:e.booking,playground:e.playground,activityId:e.activityIri,methods:e.slotData.paymentMethods,slot:e.slotData,wallet:e.wallet,client:e.client,price:"/clubs/playgrounds/timetables/blocks/prices/"+e.timeTableBlockPricesId,clubTimezone:e.club.timezone}}).then(r=>(r.onDidDismiss().then(c=>{c.data&&(e.booking=c.data.booking,e.booking.club="/clubs/"+l,c.data.success&&r.dismiss().then(u=>e.closeModal({success:!0,booking:e.booking})))}),r.present()))})()}openModalAddFriendOrUser(){this.showModalAddFriendOrUser=!0}closeModalAddFriendOrUser(){this.showModalAddFriendOrUser=!1}closeModal(e){this.ctrl.dismiss(e)}updateCountPlayer(e){this.countPlayer=e,this.slotData.prices.forEach(n=>{n.participantCount===this.countPlayer&&this.duration===n.duration&&(this.priceUsed=n,this.countPlayer=n.participantCount,this.defaultPrice=n.pricePerParticipant,this.timeTableBlockPricesId=n.id)}),this.attenders.map(n=>(n.restToPay=this.priceUsed.pricePerParticipant,n.subscriptionCard=null,n)),this.changeAttenders(this.attenders),this.cd.markForCheck()}getPriceByCountPlayer(e){this.countPlayer||(this.countPlayer=e);let n=0;const i=[];return this.slotData.prices.forEach(r=>{r.participantCount===e&&r.duration===this.duration&&i.push(r)}),n=i.reduce((r,c)=>c.pricePerParticipant<r.pricePerParticipant?c:r,i[0]).pricePerParticipant,n}getDefaultPrice(e){const n=[];return e.forEach(i=>{i.participantCount===this.countPlayer&&i.duration===this.duration&&n.push(i)}),n.reduce((i,l)=>l.pricePerParticipant<i.pricePerParticipant?l:i,n[0])}countOptionChanged(e){this.playgroundOptions.forEach(n=>{n.option==="/clubs/playgrounds/options/"+e.id&&(n.quantity=parseInt(e.quantity,10))})}optionChanged(e){const n=this.playgroundOptions.findIndex(i=>i.option===e),o=this.options.find(i=>i.id===e);-1===n?this.playgroundOptions.push({quantity:o.minQuantity?o.minQuantity:void 0,option:`/clubs/playgrounds/options/${o.id}`,price:o.price,label:o.label}):this.playgroundOptions.splice(n,1)}ngOnDestroy(){this.userSub&&this.userSub.unsubscribe(),this.currentClubSub&&this.currentClubSub.unsubscribe(),this.pricesVariationsListSub&&this.pricesVariationsListSub.unsubscribe(),this.optionsSub&&this.optionsSub.unsubscribe()}addParticipant(e){this.boolAddPart=!0,this.typeOfUserToAdd=e,this.showModalAddFriendOrUser=!1}resetAddBool(){this.boolAddPart=!1,this.typeOfUserToAdd=""}}return a.\u0275fac=function(e){return new(e||a)(t.\u0275\u0275directiveInject(A.k),t.\u0275\u0275directiveInject(d.ModalController),t.\u0275\u0275directiveInject(x.K),t.\u0275\u0275directiveInject(I.T),t.\u0275\u0275directiveInject(T.B),t.\u0275\u0275directiveInject(B.z),t.\u0275\u0275directiveInject(t.ChangeDetectorRef),t.\u0275\u0275directiveInject(M.L),t.\u0275\u0275directiveInject(y.yh),t.\u0275\u0275directiveInject(D.b))},a.\u0275cmp=t.\u0275\u0275defineComponent({type:a,selectors:[["app-booking-sport"]],inputs:{slotData:"slotData",playground:"playground",duration:"duration",activity:"activity",prices:"prices"},decls:18,vars:28,consts:[[3,"title","subtitle","isPage","backButtonAction"],[1,"content"],[1,"page-title"],[1,"shadow-bottom-ligth",3,"proposals","selected","price","currency","countChanged"],["class","page-title",4,"ngIf"],["class","shadow-bottom-ligth",3,"options","currency","optionChanged","countOptionChanged",4,"ngIf"],["class","subtitle",4,"ngIf"],[3,"currency","attenders","maxAttenders","pricePerParticipant","allDataLoaded","boolAddPart","typeOfUserToAdd","changeAttenders","showFriendOrUserModal","resetAddBool"],["data-test","go-to-confirm-booking","mode","ios","expand","block",1,"btn-next",3,"disabled","click"],[1,"do-p-2"],[3,"closeModal","addParticipant",4,"ngIf"],[1,"shadow-bottom-ligth",3,"options","currency","optionChanged","countOptionChanged"],[1,"subtitle"],[3,"closeModal","addParticipant"]],template:function(e,n){1&e&&(t.\u0275\u0275elementStart(0,"app-modal-header",0),t.\u0275\u0275listener("backButtonAction",function(){return n.closeModal({success:!1,booking:{}})}),t.\u0275\u0275pipe(1,"translate"),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(2,"ion-content",1)(3,"div",2),t.\u0275\u0275text(4),t.\u0275\u0275pipe(5,"translate"),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(6,"app-select-count-player",3),t.\u0275\u0275listener("countChanged",function(i){return n.updateCountPlayer(i)}),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(7,Q,2,0,"div",4),t.\u0275\u0275template(8,R,1,2,"app-select-playground-options",5),t.\u0275\u0275template(9,H,3,3,"div",6),t.\u0275\u0275template(10,W,2,0,"div",6),t.\u0275\u0275elementStart(11,"app-booking-attenders",7),t.\u0275\u0275listener("changeAttenders",function(i){return n.changeAttenders(i)})("showFriendOrUserModal",function(){return n.openModalAddFriendOrUser()})("resetAddBool",function(){return n.resetAddBool()}),t.\u0275\u0275elementEnd()(),t.\u0275\u0275elementStart(12,"ion-footer")(13,"ion-button",8),t.\u0275\u0275listener("click",function(){return n.goToConfirmBooking()}),t.\u0275\u0275elementStart(14,"div",9),t.\u0275\u0275text(15),t.\u0275\u0275pipe(16,"translate"),t.\u0275\u0275elementEnd()()(),t.\u0275\u0275template(17,X,1,0,"app-booking-add-user-choice-modal",10)),2&e&&(t.\u0275\u0275property("title",t.\u0275\u0275pipeBind1(1,22,"booking_playground"))("subtitle",n.playground.name)("isPage",!1),t.\u0275\u0275advance(4),t.\u0275\u0275textInterpolate(t.\u0275\u0275pipeBind1(5,24,"attenders")),t.\u0275\u0275advance(2),t.\u0275\u0275property("proposals",n.choicesCountPlayerWithPrice)("selected",n.countPlayer)("price",n.defaultPrice)("currency",n.club.currency),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",n.showOptions),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",n.showOptions),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",1!==n.countPlayer),t.\u0275\u0275advance(1),t.\u0275\u0275property("ngIf",1===n.countPlayer),t.\u0275\u0275advance(1),t.\u0275\u0275property("currency",n.club.currency)("attenders",n.attenders)("maxAttenders",n.countPlayer)("pricePerParticipant",n.defaultPrice)("allDataLoaded",n.allDataLoaded)("boolAddPart",n.boolAddPart)("typeOfUserToAdd",n.typeOfUserToAdd),t.\u0275\u0275advance(2),t.\u0275\u0275property("disabled",!n.allDataLoaded),t.\u0275\u0275advance(2),t.\u0275\u0275textInterpolate(t.\u0275\u0275pipeBind1(16,26,"next")),t.\u0275\u0275advance(2),t.\u0275\u0275property("ngIf",n.showModalAddFriendOrUser))},dependencies:[g.NgIf,d.IonButton,d.IonContent,d.IonFooter,j,$.m,Y.o,N.R,G.A,C.X$],styles:["ion-content[_ngcontent-%COMP%]{--background: var(--background-gray)}.content[_ngcontent-%COMP%]   .page-title[_ngcontent-%COMP%]{margin:0;padding:1.5rem;display:flex;font-weight:700}.content[_ngcontent-%COMP%]   .subtitle[_ngcontent-%COMP%]{font-size:var(--app-font-size);margin:0;padding:1.5rem}app-booking-add-user-choice-modal[_ngcontent-%COMP%]{display:block;position:absolute;inset:0;z-index:999}"],changeDetection:0}),a})()}}]);